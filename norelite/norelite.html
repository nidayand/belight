<!-- norelite config -->
<script type="text/x-red" data-template-name="norelite-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('norelite-config', {
        category: 'config',
        color: "rgb(218, 196, 180)",
        defaults: {
            name: {
                value: ""
            }
        },
        label: function () {
            return this.name || "norelite Config";
        }
    });
</script>

<!-- norelite source -->
<script type="text/x-red" data-template-name="norelite-source out">
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-bookmark"></i> Config</label>
        <input type="text" id="node-input-config">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-expire" placeholder="Only" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-expire" style="width: 70%;">Value can expire</label>
    </div>
    <div id="expire-details">
        <div class="form-row">
            <label for="node-input-timeout"><i class="fa fa-clock-o"></i> For</label>
            <input type="text" id="node-input-timeout" placeholder="Time" style="direction:rtl; width:50px !important">
            <select id="node-input-timeoutUnits" style="width:200px !important">
              <option value="milliseconds">Milliseconds</option>
              <option value="seconds">Seconds</option>
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-expval"><i class="fa fa-bookmark"></i> Expiration value</label>
            <input type="text" id="node-input-expval">
        </div>
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-output" placeholder="Only" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-output" style="width: 70%;">Use output</label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-bookmark"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>

</script>
<script type="text/x-red" data-help-name="norelite-source out">
    <p>A source definition node. Will store the current value of the datasource</p>
    <p>Will store whatever is in <b>msg.payload</b> into a datasource collection in the defined MongoDB</p>
    <p><b>Broadcast broker</b> is the MQTT server that will be used for communicating between the different Norelite nodes. When defining enter a prepend string to be used to uniquely identify Norelite messages</p>
    <p>If the value should only be valid for a certain period mark the expiration flag and define for how long it will be valid. It is also important to define the value that should be set for the datasource when it is expired. Default is "false"</p>
</script>
<script type="text/javascript">
    function oneditprepareDatasource() {
        $("#node-input-expire").change(function () {
            if ($("#node-input-expire").is(':checked')){
                $("#expire-details").show();
            } else {
                $("#expire-details").hide();
            }
        });

    }
    RED.nodes.registerType('norelite-source out', {
        category: 'norelite2-output',
        color: "#C7E9C0",
        defaults: {
            config: {type: "norelite-config", required: true},
            name: {value: "", required: true},
            expire: {value: false, required: true},
            timeout: {value: 100, required: false, validate: RED.validators.number()},
            timeoutUnits: {value: "seconds", required: false},
            expval : {value: false, required: false},
            output: {value:false, required:true }
        },
        inputs: 1,
        outputs: 0,
        icon: "fa-hdd-o.png",
        align: "right",
        label: function() {
            return (this.name || "undefined");
        },
        oneditprepare: oneditprepareDatasource,
        oneditsave: function(){
            var node=this;
            if ($("#node-input-output").is(":checked")){
                node.outputs=1;
            } else {
                node.outputs=0;
            }
        }
    });
</script>

<!-- norelite eval -->
<script type="text/x-red" data-template-name="norelite-eval in">
    <div class="form-row">
        <label for="node-input-config"><i class="fa fa-bookmark"></i> Config</label>
        <input type="text" id="node-input-config">
    </div>
    <div class="form-row node-input-rule-container-row" style="margin-bottom: 0px;">
        <div id="node-input-rule-container-div" style="box-sizing: border-box; border-radius: 5px; height: 310px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;">
            <ol id="node-input-rule-container" style=" list-style-type:none; margin: 0; "></ol>
        </div>
    </div>
    <div class="form-row">
        <a href="#" class="btn btn-mini" id="node-input-add-rule" style="margin-top: 4px;"><i class="fa fa-plus"></i> rule</a>
    </div>
    <div class="form-row">
        <select id="node-input-checkall" style="width:100%; margin-right:5px;">
            <option value="true">all rules must be true</option>
            <option value="false">minimum one rule must be true</option>
        </select>
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-inputson" placeholder="Only" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-inputson" style="">Use input</label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
<script type="text/x-red" data-help-name="norelite-eval in">
    <p>One of the key nodes in Norelite. It triggers on changes in sources and evaluate sources according to criterias and outputs a message that includes if the status is active or not active</p>
    <p><b>Broadcast broker</b> is the MQTT server that will be used for communicating between the different Norelite nodes. When defining enter a prepend string to be used to uniquely identify Norelite messages</p>
    <p>If <b>Use input</b> is active then inbound message will be used to forward with the status unchanged if the rule is true or status = 0 if the rule is false. The "value" will not be changed from the inbound message.</p>
    <p>The <b>output message</b> is in the format of an javascript object on <b>msg.payload</b> with the following structure: { lid : node.id, type: "rule", status : 1, value:100}. <ul>
    <li><b>lid</b> is a sender identifier (usually the node id)</li>
    <li><b>type</b> is from this node always "rule" but can in other nodes be "scenario" or "direct" (in the nrl-switch node messages from direct has precedence over scenario and scenario has precedence over rule)</li>
    <li><b>status</b> is 0 or 1 depending if the rule is active or not</li>
    <li><b>value</b> is the dim level of the switch (0-100) and will always be 100 from the rule node. Use nrl-value to modify the output</li>
    </ul>
</script>
<script type="text/javascript">
    RED.nodes.registerType('norelite-eval in', {
        color: "#E2D96E",
        category: 'norelite2-input',
        defaults: {
            config: {type: "norelite-config", required: true},
            name: {value:""},
            rules: {value:[{t:"eq", v:""}]},
            checkall: {value:"true", required:true},
            inputson: {value: false, required:true}
        },
        inputs: 0,
        outputs: 1,
        icon: "fa-question-circle.png",
        label: function() {
            return (this.name || "undefined");
        },
        oneditprepare: function() {
            var operators = [
                {v:"eq",t:"=="},
                {v:"neq",t:"!="},
                {v:"lt",t:"<"},
                {v:"lte",t:"<="},
                {v:"gt",t:">"},
                {v:"gte",t:">="},
                {v:"btwn",t:"is between"},
                {v:"cont",t:"contains"},
                {v:"regex",t:"matches regex"},
                {v:"true",t:"is true"},
                {v:"false",t:"is false"},
                {v:"null",t:"is null"},
                {v:"nnull",t:"is not null"}
            ];

            //get all conf nodes
            var sourceAllList = [];
            RED.nodes.eachNode(function(cf){
                if (cf.type==="norelite-source out"){
                    sourceAllList.push(cf);
                }
            });

            //if there are no sources, prompt to add first
            if(sourceAllList.length===0){
                $("<li>First add sources</li>").appendTo("#node-input-rule-container");
                $("#node-input-add-rule").hide();
                return;
            }

            var generateRule = function(i, rule){
                var container = $('<li/>',{style:"background: #fff; margin:0; padding:8px 0px; border-bottom: 1px solid #ccc;"});
                var row = $('<div/>').appendTo(container);

                //Add sources
                var selectSource = $('<select/>',{class:"node-input-rule-source", style:"width:120px; margin-left: 5px; text-align: left;"}).appendTo(row);
                for (var d in sourceAllList) {
                    selectSource.append($("<option></option>").val(sourceAllList[d].id).text(sourceAllList[d].name));
                }
                //Add compare
                var selectField = $('<select/>',{class:"node-input-rule-compare", style:"width:120px; margin-left: 5px; text-align: center;"}).appendTo(row);
                for (var d in operators) {
                    selectField.append($("<option></option>").val(operators[d].v).text(operators[d].t));
                }

                //Add values
                var valueField = $('<input/>',{class:"node-input-rule-value",type:"text",style:"margin-left: 5px; width: 145px;"}).appendTo(row);
                var btwnField = $('<span/>').appendTo(row);
                var btwnValueField = $('<input/>',{class:"node-input-rule-btwn-value",type:"text",style:"margin-left: 5px; width: 50px;"}).appendTo(btwnField);
                btwnField.append(" and ");
                var btwnValue2Field = $('<input/>',{class:"node-input-rule-btwn-value2",type:"text",style:"width: 50px;margin-left:2px;"}).appendTo(btwnField);

                var finalspan = $('<span/>',{style:"float: right; margin-top: 3px;margin-right: 10px;"}).appendTo(row);
                finalspan.append(' ');

                //Add deletebutton
                var deleteButton = $('<a/>',{href:"#",class:"btn btn-mini", style:"margin-left: 5px;"}).appendTo(finalspan);
                $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);

                //Add action on selectfield
                selectField.change(function() {
                    var type = selectField.children("option:selected").val();
                    if (type.length < 4) {
                        selectField.css({"width":"60px"});
                    } else if (type === "regex") {
                        selectField.css({"width":"147px"});
                    } else {
                        selectField.css({"width":"120px"});
                    }
                    if (type === "btwn") {
                        valueField.hide();
                        btwnField.show();
                    } else {
                        btwnField.hide();
                        if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else") {
                            valueField.hide();
                        } else {
                            valueField.show();
                        }
                    }
                });

                //Delete
                deleteButton.click(function() {
                    container.css({"background":"#fee"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                        $("#node-input-rule-container").children().each(function(i) {
                            $(this).find(".node-input-rule-index").html(i+1);
                        });

                    });
                });

                //Add to the main container
                $("#node-input-rule-container").append(container);

                //Update active select
                selectSource.find("option").filter(function() {return $(this).val() == rule.s;}).attr('selected',true); //Compare rule.s (source) with option
                selectField.find("option").filter(function() {return $(this).val() == rule.t;}).attr('selected',true);  //Compare rule.t (type) with option
                if (rule.t == "btwn") {
                    btwnValueField.val(rule.v);
                    btwnValue2Field.val(rule.v2);
                } else if (typeof rule.v != "undefined") {
                    valueField.val(rule.v);
                }
                selectField.change();
            }

            //Add action to the button for generating a new evaluation
            $("#node-input-add-rule").click(function() {
                generateRule($("#node-input-rule-container").children().length+1,{s:"", t:"",v:"",v2:""});
                $("#node-input-rule-container-div").scrollTop($("#node-input-rule-container-div").get(0).scrollHeight);
            });

            //Generate all saved rules
            for (var i=0;i<this.rules.length;i++) {
                var rule = this.rules[i];
                generateRule(i+1,rule);
            }
        },
        oneditsave: function() {
            if ($("#node-input-inputson").is(":checked")){
                this.inputs=1;
            } else {
                this.inputs=0;
            }
            var rules = $("#node-input-rule-container").children();
            var ruleset;
            var node = this;
            node.rules= [];
            rules.each(function(i) {
                var rule = $(this);
                var source = rule.find(".node-input-rule-source option:selected").val();
                var type = rule.find(".node-input-rule-compare option:selected").val();
                var r = {s:source, t:type};
                if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else")) {
                    if (type === "btwn") {
                        r.v = rule.find(".node-input-rule-btwn-value").val();
                        r.v2 = rule.find(".node-input-rule-btwn-value2").val();
                    } else {
                        r.v = rule.find(".node-input-rule-value").val();
                    }
                }
                node.rules.push(r);
            });
        }
    });
</script>

