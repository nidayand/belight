<!--
Configuration node for mqtt to broadcast events
-->
<script type="text/x-red" data-template-name="blbroker">
    <div class="form-row node-input-broker">
        <label for="node-config-input-broker"><i class="fa fa-globe"></i> Broker</label>
        <input class="input-append-left" type="text" id="node-config-input-broker" placeholder="localhost" style="width: 40%;" >
        <label for="node-config-input-port" style="margin-left: 10px; width: 35px; "> Port</label>
        <input type="text" id="node-config-input-port" placeholder="Port" style="width:45px">
    </div>
    <div class="form-row">
        <label for="node-config-input-prependtxt"><i class="fa fa-tag"></i> Prepend Text</label>
        <input type="text" id="node-config-input-prependtxt" placeholder="Leave blank for auto generated">
    </div>
    <div class="form-row">
        <label for="node-config-input-clientid"><i class="fa fa-tag"></i> Client ID</label>
        <input type="text" id="node-config-input-clientid" placeholder="Leave blank for auto generated">
    </div>
    <div class="form-row">
        <label for="node-config-input-user"><i class="fa fa-user"></i> Username</label>
        <input type="text" id="node-config-input-user">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('blbroker',{
        category: 'config',
        defaults: {
            broker: {value:"",required:true},
            port: {value:1883,required:true,validate:RED.validators.number()},
            clientid: { value:"" },
            prependtxt : { value: "/belight", required: true }
        },
        credentials: {
            user: {type:"text"},
            password: {type: "password"}
        },
        label: function() {
            if (this.broker == "") { this.broker = "localhost"; }
            return (this.clientid?this.clientid+"@":"")+this.broker+":"+this.port;
        }
    });
</script>

<!--
Configuration node for the database
-->
<script type="text/x-red" data-template-name="bldb">
    <div class="form-row">
        <label for="node-config-input-hostname"><i class="fa fa-bookmark"></i> Host</label>
        <input class="input-append-left" type="text" id="node-config-input-hostname" placeholder="localhost" style="width: 40%;" >
        <label for="node-config-input-port" style="margin-left: 10px; width: 35px; "> Port</label>
        <input type="text" id="node-config-input-port" placeholder="27017" style="width:45px">
    </div>
    <div class="form-row">
        <label for="node-config-input-db"><i class="fa fa-database"></i> Database</label>
        <input type="text" id="node-config-input-db" placeholder="test">
    </div>
    <div class="form-row">
        <label for="node-config-input-user"><i class="fa fa-user"></i> Username</label>
        <input type="text" id="node-config-input-user">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-lock"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('bldb', {
        category: 'config',
        color: "rgb(218, 196, 180)",
        defaults: {
            hostname: {value: "127.0.0.1", required: true},
            port: {value: 27017, required: true},
            db: {value: "belight", required: true},
            name: {value: ""}
        },
        credentials: {
            user: {type: "text"},
            password: {type: "password"}
        },
        label: function() {
            return this.name || this.hostname + ":" + this.port + "/" + this.db;
        }
    });
</script>

<!-- *********************************************
        DATASOURCE: output node 

Expval: value to be set when the inbound value has expired
Broker: The MQTT broker to be used for broadcasting updated to related components
DB: The MongoDB server to store the persistent data
Name: The data source name to be stored in MongoDB and used for consumers to say what rules apply

     ********************************************* -->
<script type="text/x-red" data-help-name="datasource out">
    <p>A datasource definition node. Will store the current value of the datasource</p>
    <p>Will store whatever is in <b>msg.payload</b> into a datasource collection in the defined MongoDB</p>
    <p><b>Broadcast broker</b> is the MQTT server that will be used for communicating between the different Belight nodes. When defining enter a prepend string to be used to uniquely identify Belight messages</p>
    <p>If the value should only be valid for a certain period mark the expiration flag and define for how long it will be valid. It is also important to define the value that should be set for the datasource when it is expired. Default is "false"</p>
</script>
<script type="text/x-red" data-template-name="datasource out">
    <div class="form-row">
        <label for="node-input-bldb"><i class="fa fa-bookmark"></i> Store</label>
        <input type="text" id="node-input-bldb">
    </div>
    <div class="form-row">
        <label for="node-input-blbroker"><i class="fa fa-bookmark"></i> Broadcast broker</label>
        <input type="text" id="node-input-blbroker">
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-expire" placeholder="Only" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-expire" style="width: 70%;">Value can expire</label>
    </div>
    <div id="expire-details">
        <div class="form-row">
            <label for="node-input-timeout"><i class="fa fa-clock-o"></i> For</label>
            <input type="text" id="node-input-timeout" placeholder="Time" style="direction:rtl; width:50px !important">
            <select id="node-input-timeoutUnits" style="width:200px !important">
              <option value="milliseconds">Milliseconds</option>
              <option value="seconds">Seconds</option>
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-expval"><i class="fa fa-bookmark"></i> Expiration value</label>
            <input type="text" id="node-input-expval">
        </div>
    </div>   
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
</script>
<script type="text/javascript">
    function oneditprepareDatasource() {
        $("#node-input-expire").change(function () {
            if ($("#node-input-expire").is(':checked')){
                $("#expire-details").show();
            } else {
                $("#expire-details").hide();
            }
        });
            
    }
    RED.nodes.registerType('datasource out', {
        category: 'belight-output',
        color: "#FFCC66",
        defaults: {
            bldb: {type: "bldb", required: true},
            name: {value: "", required: true},
            blbroker: {type: "blbroker", required: true},
            expire: {value: false, required: true},
            timeout: {value: 100, required: false, validate: RED.validators.number()},
            timeoutUnits: {value: "seconds", required: false},
            expval : {value: false, required: false}
        },
        inputs: 1,
        outputs: 0,
        icon: "datasource.png",
        align: "right",
        label: function() {
            return "Datasource: "+this.name;
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: oneditprepareDatasource
    });
</script>